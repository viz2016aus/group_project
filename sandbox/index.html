<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Group Project</title>
<link rel="stylesheet" type="text/css" href="css/main.css">
<script src="js/jquery-2.2.1.min.js"></script>
<script src="js/d3.js"></script>
<script type="text/javascript">
var aus_lat_u = 49.2;
var aus_lat_l = 46.3;
var aus_lon_r = 17.2;
var aus_lon_l = 9.4;
var pol_dim = [];
var pol_min_x;
var pol_min_y;
var pol_max_x;
var pol_max_y;
var y_lat;
var x_lon;
var svg;
var data_arr = [];
var sel_data_arr = [];
var obj_clicked = 0;

$(document).keyup(function(e) {
	if (e.keyCode == 27 && obj_clicked == 1) {
		sel_data_arr = [];
		svg.selectAll("circle")
			.transition()
				.duration(500)
					.style("fill", "red")
					.style("stroke-width", 0)
					.style("opacity", 0.2);
		obj_clicked = 0;
    }
});

function init_svg() {
var pol_arr = d3.selectAll("polygon").attr("points").trim().split(" ");
	for (var i = 0; i < pol_arr.length; i++) {
		pol_dim[i] = [pol_arr[i].split(",")[0],pol_arr[i].split(",")[1]];
    }
pol_dim[pol_arr.length] = [pol_dim[0][0],pol_dim[0][1]];
pol_min_x = Math.min.apply(null, pol_dim.map(function (e) { return e[0]}));
pol_min_y = Math.min.apply(null, pol_dim.map(function (e) { return e[1]}));
pol_max_x = Math.max.apply(null, pol_dim.map(function (e) { return e[0]}));
pol_max_y = Math.max.apply(null, pol_dim.map(function (e) { return e[1]}));
y_lat = (pol_max_y - pol_min_y) / (aus_lat_u - aus_lat_l);
x_lon = (pol_max_x - pol_min_x) / (aus_lon_r - aus_lon_l);
svg = d3.select("#svg_div").append("svg")
    .attr("width", pol_max_x)
    .attr("height", pol_max_y);
}

function draw_points(highway, checkpoint, point_num, latitude, longitude, qty) {
lat = y_lat * (aus_lat_u - latitude) + pol_min_y;
lon = x_lon * (longitude - aus_lon_l) + pol_min_x;
svg.append("circle")
	.attr("cx", lon)
	.attr("cy", lat)
	.attr("id", highway + "_" + point_num)
	.attr("class", highway)
	.attr("opacity", 0.2)
	.attr("stroke-width", 0)
	.attr("r", 20)
	.attr("fill", "red")
	.on("click", 
		function(d) {
			id_str = this.id;
			obj_i = id_str.split("_");
			sel_data_arr = [];
			if (d3.event.ctrlKey) {
				for (j = 0; j < data_arr.length; j++) {
					if (obj_i[1] == data_arr[j][2]) {
						push_val = [];
						push_val[0] = data_arr[j][0];
						push_val[1] = data_arr[j][1];
						push_val[2] = data_arr[j][2];
						push_val[3] = data_arr[j][3];
						push_val[4] = data_arr[j][4];
						push_val[5] = data_arr[j][5];
						sel_data_arr.push(push_val);
					} else {
						svg.selectAll("#" + data_arr[j][0] + "_" + data_arr[j][2])
							.transition()
    							.duration(300)
									.style("stroke-width", 0)
									.style("fill", "red")
									.style("opacity", 0.2);
					}
				}
				svg.selectAll("#" + id_str)
					.transition()
    					.duration(300)
							.style("stroke", "red")
							.style("stroke-width", 3)
							.style("fill", "white")
							.style("opacity", 0.6);
				obj_clicked = 1;
			} else {
				for (j = 0; j < data_arr.length; j++) {
					if (obj_i[0] == data_arr[j][0]) {
						push_val = [];
						push_val[0] = data_arr[j][0];
						push_val[1] = data_arr[j][1];
						push_val[2] = data_arr[j][2];
						push_val[3] = data_arr[j][3];
						push_val[4] = data_arr[j][4];
						push_val[5] = data_arr[j][5];
						sel_data_arr.push(push_val);
						//document.getElementById("debug_div").innerHTML = document.getElementById("debug_div").innerHTML + data_arr[j][2] + "<br>";
					}
						svg.select("#" + data_arr[j][0] + "_" + data_arr[j][2])
							.transition()
    							.duration(300)
									.style("stroke-width", 0)
									.style("fill", "red")
									.style("opacity", 0.2);
				}
						svg.selectAll("." + obj_i[0])
							.transition()
    							.duration(300)
									.style("stroke", "red")
									.style("stroke-width", 3)
									.style("fill", "white")
									.style("opacity", 0.6);
						obj_clicked = 1;
			}
		}
	)
	.on("mouseover", 
		function(d) {
			id_str = this.id;
			obj_i = id_str.split("_");
			if (d3.event.ctrlKey) {
				svg.select("#" + id_str)
					.transition()
    					.duration(300)
							.style("stroke-width", 3)
							.style("fill", "red")
							.style("opacity", 0.6);
				document.getElementById("info_div_1").innerHTML = obj_i[0];
				for (j = 0; j < data_arr.length; j++) {
					if (obj_i[1] == data_arr[j][2]) {
						document.getElementById("info_div_2").innerHTML = data_arr[j][1];
					}
				}
			} else {
				svg.selectAll("." + obj_i[0])
					.transition()
    					.duration(300)
							.style("stroke-width", 3)
							.style("opacity", 0.6);
				document.getElementById("info_div_1").innerHTML = obj_i[0];
				document.getElementById("info_div_2").innerHTML = data_arr[j][1];
			}
		}
	)
	.on("mouseout", 
		function(d) {
			id_str = this.id;
			obj_i = id_str.split("_");
			svg.selectAll("." + obj_i[0])
				.transition()
    				.duration(300)
						.style("stroke-width", 0)
						.style("fill", "red")
						.style("opacity", 0.2);
						document.getElementById("info_div_1").innerHTML = "";
						document.getElementById("info_div_2").innerHTML = "";
			if (sel_data_arr.length > 0) {
				for (k = 0; k < sel_data_arr.length; k++) {
					svg.select("#" + sel_data_arr[k][0] + "_" + sel_data_arr[k][2])
						.transition()
    						.duration(300)
								.style("stroke", "red")
								.style("stroke-width", 3)
								.style("fill", "white")
								.style("opacity", 0.6);
					document.getElementById("info_div_1").innerHTML = "";
					document.getElementById("info_div_2").innerHTML = "";
				}
			}
		}
	);
}

function get_data() {
d3.csv("data/Feb_demo.csv", function(data) {
	data.forEach(
		function(d){ 
			push_val = [];
			push_val[0] = d.highway;
			push_val[1] = d.checkpoint;
			push_val[2] = d.point_num;
			push_val[3] = d.latitude;
			push_val[4] = d.longitude;
			push_val[5] = d.qty;
			data_arr.push(push_val);
			draw_points(d.highway, d.checkpoint, d.point_num, d.latitude, d.longitude, d.qty);
		}
	);
});
}
</script>
</head>

<body onload="init_svg()">
<div id="debug_div"></div>
<font id="info_div_font_1"><div id="info_div_1"></div></font>
<font id="info_div_font_2"><div id="info_div_2"></div></font>
<div id="svg_div"></div>
<div id="map_div"><?php include ('bilder/map.svg'); ?></div>
<!--<div id="austria_map"><img src="bilder/map_with_coord.jpg"></div>-->
<div><img id="map_tmp" src="bilder/tmp.jpg"><div>
<input id="map_but" type="button" value="Map data" onclick="get_data()">
</body>
</html>
